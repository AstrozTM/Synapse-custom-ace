<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Editor</title>
  <style type="text/css" media="screen">
    body {
      overflow: hidden;
    }

    #editor {
      margin: 0;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }
  </style>
  <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="ace/ext-language_tools.js"></script>
  <script type="module" src="luamin.js"></script>
</head>

<body style="background-color: #282f38">
  <pre id="editor"></pre>
  <script>

var indentation = "  "
    , js_lua_code = document.querySelector("#js_lua_code")
    , js_lua_beautify = document.querySelector("#js_lua_beautify")
  ;
  function startsWith(self, phrase) {
    return phrase.length && self.length && !self.indexOf(phrase);
  }
  function endsWith(self, phrase) {
    var last_index_of = self.lastIndexOf(phrase);
    return phrase.length && self.length && ~last_index_of && (last_index_of === self.length - phrase.length);
  }
  function trim(self) {
    return self.replace(/^\s+|\s+$/g, "");
  }

  function repeat(self, times) {
    times |= 0;
    if(times < 1) return "";
    var copy = self;
    while(--times) self += copy;
    return self;
  }

  function stripComments(string) {
    // walk through the line finding the first occurrence of -- not in a string
    var sq = 0, dq = 0;
    for (var i = 0; i < string.length; i++) {
      if (string[i] == '\'') sq++;
      if (string[i] == '\"') dq++;
      if (string[i] == '-' && string[i + 1] == '-' &&
          sq % 2 == 0 && dq % 2 == 0) {
        return string.substr(0, i);
      }
    }
    return string;
  }
  function luaBeautifier(string, indentation) {
    var current_indentation = 0
      , next_indentation = 0
    ;

    return string.split(/\r?\n/).map(function(raw_line) {
      line = trim(stripComments(raw_line));

      current_indentation = next_indentation;

      // Entering in a block
      if(
        startsWith(line, "local function") ||
        startsWith(line, "function") ||
        startsWith(line, "repeat") ||
        startsWith(line, "while") ||
        endsWith(line, "then") ||
        endsWith(line, "do") ||
        endsWith(line, "{")
      ) next_indentation = current_indentation + 1;

      // Leaving a block
      if(line === "end" || startsWith(line, "}") || startsWith(line, "until")) {
        current_indentation--;
        next_indentation = current_indentation;
      }

      // Entering in a block but this line must be pushed back
      if(startsWith(line, "else") || startsWith(line, "elseif")) {
        current_indentation--;
        next_indentation = current_indentation + 1;
      }

      var out_line = trim(raw_line);
      return !out_line ? "" : repeat(indentation, current_indentation) + out_line;
    }).join("\n");
  }

    ace.require("ace/ext/language_tools");
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/tomorrow_night_eighties");
    editor.session.setMode("ace/mode/lua");
    editor.setOption("enableLiveAutocompletion", true);
    editor.setOption("cursorStyle", "smooth");
    editor.setOption('animatedScroll', true);
    editor.setOption('highlightActiveLine', true);
    editor.setOption('useElasticTabstops', true);
    editor.setOption('enableEmmet', true);
    editor.setOption('enableSnippets', true);
    editor.setShowPrintMargin(false);
    document.getElementById('editor').style.fontSize = '13px';

    var GetText;
    var SetText;
    var ClearText;
    var SetTheme;

    /* internal code */
    GetText = function () {
      return editor.getValue();
    }

    SetText = function (x) {
      editor.setValue(x);
      editor.session.setValue(x);
    }

    ClearText = function () {
      editor.setValue("");
    }

    SetTheme = function (th) {
      editor.setTheme("ace/theme/" + th);
    }

    editor.on("input", async function () {
      await CefSharp.BindObjectAsync("synServiceAsync");

      synServiceAsync.textChanged(editor.getValue());
    });

    document.addEventListener('keydown', async e => {
      if (e.ctrlKey) {
        if (e.key === 's') {
          e.preventDefault();

          await CefSharp.BindObjectAsync("synServiceAsync");

          synServiceAsync.saveRequest(editor.getValue());
        }
        else if (e.key === 'o') {
          e.preventDefault();

          await CefSharp.BindObjectAsync("synServiceAsync");

          synServiceAsync.openRequest();
        }
        else if (e.key === 'b') {
          e.preventDefault();
          let Result = luaBeautifier(editor.getValue(), indentation)
          editor.setValue(Result)
        }
        else if (e.key === 'c') {
          e.preventDefault();
          editor.setValue("")
        }
      }
    });

    document.oncontextmenu = function () {
      return false;
    }
  </script>
</body>

</html>